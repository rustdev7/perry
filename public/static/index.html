<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Productos — Google Sheets CSS</title>

<style>
/* --- ESTILOS GENERALES (MODO OSCURO) --- */
body {
  background: #1a1a1a;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  font-family: system-ui, -apple-system, sans-serif;
}

h2 {
  text-align: center;
  margin-top: 0;
}

/* Buscador simple */
#search-container {
  max-width: 1000px;
  margin: 0 auto 20px auto;
  display: flex;
  gap: 10px;
}
#searchInput {
  flex: 1;
  padding: 12px;
  background: #2d2d2d;
  border: 1px solid #444;
  color: #fff;
  border-radius: 6px;
  font-size: 16px;
  box-sizing: border-box;
}
#searchInput:focus {
  outline: none;
  border-color: #666;
}
#categoryFilter {
  padding: 12px;
  background: #2d2d2d;
  border: 1px solid #444;
  color: #fff;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  min-width: 180px;
}
#categoryFilter:focus {
  outline: none;
  border-color: #666;
}

/* Paginación */
#pagination {
  max-width: 1000px;
  margin: 20px auto;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

#pagination button {
  padding: 8px 16px;
  background: #2d2d2d;
  border: 1px solid #444;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

#pagination button:hover:not(:disabled) {
  background: #3a3a3a;
  border-color: #666;
}

#pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#pagination button.active {
  background: #4a4a4a;
  border-color: #888;
  font-weight: bold;
}

#pagination .page-info {
  color: #aaa;
  font-size: 14px;
}

/* --- TABLA CSS PURA --- */
.table-container {
  max-width: 1000px;
  margin: 0 auto;
  overflow-x: auto; /* Scroll lateral si es necesario en pantallas intermedias */
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #2d2d2d;
  border-radius: 8px;
  overflow: hidden;
}

th, td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #3a3a3a;
}

th {
  background: #333;
  color: #bbb;
  text-transform: uppercase;
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

tr:last-child td {
  border-bottom: none;
}

/* Imágenes en la tabla */
.img-cell img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
  display: block;
}

/* --- VISTA MÓVIL (TARJETAS) --- */
@media screen and (max-width: 768px) {
  #search-container {
    flex-direction: column;
  }
  
  #categoryFilter {
    min-width: 100%;
  }
  
  /* Ocultamos cabeceras de tabla, hacemos bloques los elementos */
  table, thead, tbody, th, td, tr {
    display: block;
  }
  
  thead {
    display: none; /* Ocultar encabezados en móvil */
  }

  tr {
    margin-bottom: 20px;
    background: #262626;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  }

  td {
    display: flex;
    flex-direction: column; /* Columna: título arriba, contenido abajo */
    align-items: flex-start;
    border-bottom: 1px solid #333;
    padding: 10px 15px;
    font-size: 0.95rem;
    text-align: left;
  }

  /* Usamos data-label para poner el título arriba */
  td::before {
    content: attr(data-label);
    font-weight: bold;
    text-transform: uppercase;
    color: #888;
    margin-bottom: 5px;
    font-size: 0.85rem;
  }

  /* --- TRATAMIENTO ESPECIAL PARA LA FOTO EN MÓVIL --- */
  /* Queremos que la foto esté arriba, centrada y grande */
  td[data-label="FOTO"] {
    display: block;
    text-align: center;
    padding: 0;
    border-bottom: none;
  }
  
  td[data-label="FOTO"]::before {
    display: none; /* Ocultamos la etiqueta "FOTO:" */
  }

  td[data-label="FOTO"] img {
    width: 100%;
    height: auto; /* Altura fija para la portada de la card */
    width: 100%;
    object-fit: cover;
    border-radius: 8px 8px 0 0; /* Redondear solo arriba */
  }

  /* Reordenar visualmente para que la foto quede primera si en el HTML no lo está */
  /* Flexbox en el TR para ordenar */
  tr {
    display: flex;
    flex-direction: column;
  }
  
  /* Forzamos que la celda de la foto vaya primero */
  td[data-label="FOTO"] {
    order: -1; 
  }
}
</style>
</head>
<body>

<div id="search-container">
  <input type="text" id="searchInput" placeholder="Buscar producto...">
  <select id="categoryFilter">
    <option value="">Todas las categorías</option>
    <option value="Accesorios">Accesorios</option>
    <option value="Repuestos">Repuestos</option>
    <option value="Servicios">Servicios</option>
  </select>
</div>

<div class="table-container">
  <table id="productsTable">
    <thead>
      <!-- Los encabezados se generarán dinámicamente -->
    </thead>
    <tbody>
      <!-- Las filas se generarán dinámicamente -->
    </tbody>
  </table>
  <p id="loading" style="text-align:center; color:#888;">Cargando datos...</p>
</div>

<div id="pagination"></div>

<script>
// Referencias al DOM
const tableHead = document.querySelector('#productsTable thead');
const tableBody = document.querySelector('#productsTable tbody');
const loadingMsg = document.getElementById('loading');
const searchInput = document.getElementById('searchInput');
const categoryFilter = document.getElementById('categoryFilter');
const paginationDiv = document.getElementById('pagination');

let allRowsData = []; // Guardamos los datos originales para filtrar
let filteredData = []; // Datos después de aplicar filtros
let currentPage = 1;
const itemsPerPage = 5;

// Función para aplicar ambos filtros
function applyFilters() {
  const searchTerm = searchInput.value.toLowerCase();
  const selectedCategory = categoryFilter.value;
  
  filteredData = allRowsData.filter(row => {
    // Filtro de categoría
    const categoryMatch = !selectedCategory || 
      (row.CATEGORIA && row.CATEGORIA.toString().toLowerCase() === selectedCategory.toLowerCase());
    
    // Filtro de búsqueda
    const searchMatch = !searchTerm || 
      Object.values(row).some(val => 
        String(val).toLowerCase().includes(searchTerm)
      );
    
    return categoryMatch && searchMatch;
  });
  
  currentPage = 1; // Resetear a la primera página cuando se filtra
  renderPage();
}

// Función para renderizar la página actual
function renderPage() {
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageData = filteredData.slice(startIndex, endIndex);
  
  renderTable(pageData);
  renderPagination();
}

// Función para renderizar los controles de paginación
function renderPagination() {
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  
  if (totalPages <= 1) {
    paginationDiv.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // Botón anterior
  html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>← Anterior</button>`;
  
  // Botones de páginas
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
      html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
    } else if (i === currentPage - 2 || i === currentPage + 2) {
      html += `<span class="page-info">...</span>`;
    }
  }
  
  // Botón siguiente
  html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente →</button>`;
  
  // Info de página
  html += `<span class="page-info">Página ${currentPage} de ${totalPages} (${filteredData.length} resultados)</span>`;
  
  paginationDiv.innerHTML = html;
}

// Función para cambiar de página
function changePage(page) {
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  if (page < 1 || page > totalPages) return;
  
  currentPage = page;
  renderPage();
  
  // Scroll suave hacia arriba
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Función para renderizar la tabla HTML
function renderTable(rows) {
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  if (rows.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="100%" style="text-align:center">No se encontraron resultados</td></tr>';
    return;
  }

  // 1. Obtener columnas basadas en el primer objeto (claves)
  // Nota: Asumimos que todos los objetos tienen las mismas claves ordenadas
  const columns = Object.keys(rows[0]);

  // 2. Crear Encabezados (THEAD)
  const trHead = document.createElement('tr');
  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    trHead.appendChild(th);
  });
  tableHead.appendChild(trHead);

  // 3. Crear Filas (TBODY)
  rows.forEach(item => {
    const tr = document.createElement('tr');

    columns.forEach(col => {
      const td = document.createElement('td');
      const value = item[col];

      // Asignar data-label para el CSS Responsivo
      td.setAttribute('data-label', col);

      // Lógica específica para columnas (Foto, Precio, Descripción)
      
      if (col === "FOTO" && value && value.startsWith("http")) {
        // Es una imagen
        td.innerHTML = `<img src="${value}" alt="Producto" loading="lazy">`;
        td.classList.add('img-cell');
      } else if (col === "PRECIO") {
        // Formatear precio si es número
        const num = parseFloat(value);
        if (!isNaN(num)) {
          td.textContent = "$" + num.toFixed(2);
        } else {
          td.textContent = value;
        }
      } else {
        // Texto normal
        td.textContent = value;
        
        // Justificar texto de la descripción
        if (col === "DESCRIPCION") {
          td.style.textAlign = "justify";
        }
      }

      tr.appendChild(td);
    });

    tableBody.appendChild(tr);
  });
}

// Lógica de filtrado
searchInput.addEventListener('keyup', applyFilters);
categoryFilter.addEventListener('change', applyFilters);

// Carga de datos (igual que tu script original, adaptado al final)
async function cargarDesdeSheets() {
  try {
   // const url = "https://docs.google.com/spreadsheets/d/14kANeYDN6M8w0oVebP-A02EIIt_YO7NPXwWrzSYzF4M/gviz/tq?tqx=out:json";
   // const url = "https://docs.google.com/spreadsheets/d/172z33e8vBoJOkaj11o6dD89xqqY8KzD3tANjN5NQwuk/gviz/tq?tqx=out:json"
    const url = "https://docs.google.com/spreadsheets/d/14kANeYDN6M8w0oVebP-A02EIIt_YO7NPXwWrzSYzF4M/gviz/tq?tqx=out:json";

    const res = await fetch(url);
    const text = await res.text();

    const json = JSON.parse(
      text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1)
    );

    // Procesar encabezados
    const headers = json.table.cols.map(c => {
      const label = (c.label || "").trim();
      return label.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
    });

    // Procesar filas
    const rows = json.table.rows.map(r => {
      const obj = {};
      r.c.forEach((cell, i) => {
        const header = headers[i];
        // Manejo seguro de nulos
        if (!cell) {
            obj[header] = "";
        } else if (cell.v !== undefined && cell.v !== null) {
            obj[header] = cell.v;
        } else {
            obj[header] = "";
        }
      });
      return obj;
    });

    console.log("Datos cargados:", rows.length);
    
    // Guardar en variable global y renderizar
    allRowsData = rows;
    filteredData = rows;
    loadingMsg.style.display = 'none';
    renderPage();
    
  } catch (error) {
    console.error("Error:", error);
    loadingMsg.textContent = "Error al cargar datos. Verifica la consola.";
  }
}

cargarDesdeSheets();
</script>

</body>
</html>